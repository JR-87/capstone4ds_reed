---
title: "Predicting Survival Probability of NASA Aircraft Engines"
subtitle: "Using Cox Proportional Hazards Model"
author: "Jayme Reed & Brad Paton (Advisor: Dr. Cohen)"
date: last-modified
date-format: long
format:
  revealjs:
    theme: moon
    smaller: true
course: Capstone Projects in Data Science
bibliography: references.bib # file contains bibtex for references
#always_allow_html: true # this allows to get PDF with HTML features
self-contained: true
execute: 
  warning: false
  message: false
  echo: false
editor: 
  markdown: 
    wrap: 72
---

```{r, warning=FALSE, include=FALSE}
#Load packages
library(tidyverse)
library(gridExtra)
library(grid)
library(survival)
library(survminer)
library(ggpubr)
library(magrittr)
library(ggfortify)
library(knitr)
library(sjPlot)
library(broom)
```

```{r, echo = FALSE}
#generation of the model for sample plots
example_surv_object <- Surv(time = lung$time, event = lung$status)

example_coxmodel <- coxph(example_surv_object ~ meal.cal, data = lung)
```

## Cox Proportional Hazards (CPH) Model

What is it?

::: incremental
-   A statistical regression method specializing in modeling
    time-to-event predictions with survival data [@Abeysekera2009]

    -   Survival data has a value for time and an indicator column for
        an event

-   Is a method that can deal with censored data

    -   Censored data is when the information about an individual in a
        study is only known for a certain period of time [@klein2005]

-   Primarily used in the health field but has applications in
    predicting bank failure, the survival probability of machines, and
    insurance likelihood payouts
:::

## Limitations

::: incremental
-   The model assumes that as time goes on, the survival probability
    will approach zero with no survivors [@asghar2024]

-   The proportional hazards assumption can limit the ability to
    correctly predict the effect of a variable [@jiang2024]

-   The covariate selection can become biased and may not accurately
    represent the true data [@wang2025],[@zhang2025]

-   The model cannot provide a specific value for when the event will
    happen, only the probability of when the event might happen
:::

## Mathematical Formulas

-   Survival Function: $S(x) = \int_{x}^{\infty} f(x)dx$

-   Hazard Function:
    $h(x) = \lim\limits_{\Delta x \rightarrow 0} \frac{P[x \leq X < x + \Delta x|X \geq x]}{\Delta x}$

-   CPH Model Hazard Function:
    $h(t|\mathbf Z) = h_0(t)\text{exp}(\sum\limits_{k=1}^{p} \beta_kZ_k)$

-   Proportional Hazards Ratio:
    $\frac{h(t|\mathbf Z)}{h(t|\mathbf Z*)} = \text{exp}[\sum\limits_{k=1}^{p} \beta_k(Z_k - Z_k^*)]$

-   Cumulative Hazard Function: $H(x) = \int_0^x h(u) du$

-   Concordance Index: $C = \frac{c + \frac{t_x}{2}}{c + d + t_x}$

-   Survival Probability: $S(t) = e^{-H(t)}$, where $H(t)$ is the above
    cumulative hazard function

## Assumptions

There are four assumptions for CPH:

::: incremental
-   Independence assumption

    -   Assumes that the survival times of observed subjects are
        independent of each other [@nahhas2025]

-   Non-informative Censoring Assumption

    -   Assumes that censoring is non-informative [@nahhas2025]

-   Linearity Assumption

    -   Assumes the relationship between covariates and the outcome is a
        linear relationship [@nahhas2025]

-   Proportional Hazards Assumption

    -   Assumes the ratio of hazards rates for any two subjects are
        constant at all times [@Bustan2018]
:::

## Linearity Assumption

-   Tested using the Martingale residuals for each covariate using the
    equation Martingale Residuals = Observed Events - Expected Results
    [@nahhas2025]

-   If the plots are linear and appear to have a slope of zero, the
    assumption is not violated [@Amini2015]

```{r}
#| fig-align: center
example_martingale <- resid(example_coxmodel, type = "martingale")

plot(example_martingale, 
     main = "Martingale Residuals: Example Covariate",
     ylab = "Martingale Residuals for Example Covariate",
     xlab = "Value Range for Example Covariate")
abline(h = 0, col = "red")

```

## Proportional Hazards Assumption

-   The test is verified using the Schoenfeld partial residuals which
    are the difference between the value of the covariate and the
    expected value of the covariate at the time of failure [@klein2005]

::: panel-tabset
#### Graph

```{r}
example_phtest <- cox.zph(example_coxmodel)

plot(example_phtest[1],
     ylab = "Covariate Schoenfeld Residual",
     xlab = "Time")
```

#### Table

```{r}
multi <- coxph(example_surv_object ~ meal.cal + age, data = lung)
ph_tibble <- cox.zph(multi) %>%
  pluck("table") %>%
  as.data.frame() %>%
  tibble::rownames_to_column("variable") %>%
  as_tibble()
kable(ph_tibble, format = "markdown")
```
:::

## Kaplan-Meier Survival Curve

::: incremental
-   Provides visualization for the Kaplan-Meier estimator

-   Is considered to be well defined up until the largest observed study
    time $t_{max}$

-   Demonstrates the time where the event being modeled is expected to
    occur
:::

```{r}
#| fig-align: center
example_curve <- survfit(example_coxmodel)

ggsurvplot(example_curve,
           data = lung,
           title = "Example Survival Curve",
           xlab = "Time",
           ylab = "Survival Probability",
           legend = "none")
```

## Forest Plot

-   Provides visualization of the effects of each covariate on the
    hazard ratio

-   A positive effect indicates a positive correlation with the hazard
    ratio

```{r, warning=FALSE}
#| fig-align: center
forest <- coxph(example_surv_object ~ age + sex, data = lung)

plot_model(forest,
           dot.size = 1,
           line.size = 1,
           colors = "red")+
  theme_bw()+
  labs(title = "Estimated Effects of Covariates on Hazard Ratios")+
  ylab(label = "Covariates")+
  xlab(label = "Estimated Effect on Hazard Ratio")

```

## Evaluation

## Prediction

## Data Structure, Exploration, and Visualization

## Creating CPH Model

## Checking Assumptions

## Adjusting the Model

## Model Results

## Conclusion

## References
